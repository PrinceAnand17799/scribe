<div id="filterWrapper">
        <div id="chartFilters">
          <div class="filterHead">Filter by Plan Option</div>
          <div class="chartFilter">
            <input type="checkbox" ng-model="chartFilter.HSA" ng-change="applyChartFilter()" />
            <label>HSA-eligible</label>
          </div>
          <div class="chartFilter">
            <input type="checkbox" ng-model="chartFilter.OON_Availaible" ng-change="applyChartFilter()" />
            <label>Out-of-Network Coverage Available</label>
          </div>
        </div>
      </div>
      <div id="chartWrapper">
        <canvas id="chart"></canvas>
      </div>
      <div id="chartWrappermsg"></div>


chartData = {}
  $scope.chartFilter={
    HSA: false,
    Rally: false,
    OON_Availaible: false
  }

$scope.applyChartFilter = function(){
    $scope.initalizeChartData();
    $scope.prepChartData();
    $scope.renderChart();
  }

$scope.initalizeChartData = function(){
    chartData = {
    labels: [],
    datasets: [
      { data: [], stack: 'Stack 1', backgroundColor: '#003c71', label: 'Your Annual Premium' },
      { data: [], stack: 'Stack 1', backgroundColor: '#aace15', label: 'Deductible' },
      { data: [], stack: 'Stack 1', backgroundColor: '#84ad67', label: 'Copay/Coinsurance Maximum' },
      { data: [], stack: 'Stack 0', backgroundColor: '#ffdb00', label: 'HSA' }]
    }
    if (!$scope.config.isHawaiiZip()){
      chartData.datasets.splice(3, 0, { data: [], stack: 'Stack 0', backgroundColor: '#0066F5', label: 'Tobacco-free Credits*' })
    }

  $scope.prepChartData = function(){
    var planshow=[];
    $scope.medRates.forEach(function (rateRow, ind) {
      if (ind) {
        //ADD TO CHART DATA SETS IF NO FILTERS APPLIED 
        //OR ADD ONLY THOSE OPTIONS THAT QUALIFY THE FILTER
        if ((!$scope.chartFilter.HSA && !$scope.chartFilter.OON_Availaible) ||
          ($scope.chartFilter.HSA && !$scope.chartFilter.OON_Availaible && $scope.chartFilter.HSA == rateRow[12]) ||
          ($scope.chartFilter.OON_Availaible && !$scope.chartFilter.HSA && $scope.chartFilter.OON_Availaible == rateRow[13]) ||
          ($scope.chartFilter.HSA && !$scope.chartFilter.OON_Availaible && $scope.chartFilter.HSA == rateRow[12]) ||
          ($scope.chartFilter.HSA && $scope.chartFilter.OON_Availaible && $scope.chartFilter.HSA == rateRow[12] && $scope.chartFilter.OON_Availaible == rateRow[13]) ||
          ($scope.chartFilter.HSA && $scope.chartFilter.OON_Availaible && $scope.chartFilter.HSA == rateRow[12] && $scope.chartFilter.OON_Availaible == rateRow[13]) || (!$scope.chartFilter.HSA && $scope.chartFilter.OON_Availaible && $scope.chartFilter.OON_Availaible == rateRow[13])) {
          $("#chartWrapperNew").hide();

          //  if(!$scope.enableNarrowNetwork && rateRow[1].indexOf("(Advocate Health System Network Choice)")>=0 && $scope.chartFilter.OON_Availaible || rateRow[1].indexOf("Hawaii")>=0 && $scope.chartFilter.HSA || rateRow[1].indexOf("Hawaii")>=0 ) {
          if (!$scope.enableNarrowNetwork && rateRow[1].indexOf("(Advocate Health System Network Choice)")>=0 && $scope.chartFilter.OON_Availaible && $scope.chartFilter.HSA) {
            console.log(planshow)
            if (planshow.length == 0) {
              $("#chartWrapper").hide();
              $("#chartWrappermsg").show();
              $("#chartWrappermsg").html('</div><h4>No applicable options.</h4></div>');
            } else {
              $("#chartWrapper").show();
              $("#chartWrappermsg").hide();
            }

          }
          else {
            //PLAN NAME WITH NET COST: 
            $("#chartWrapper").show();
            $("#chartWrappermsg").hide();
            planshow.push(rateRow[1])
            if ($scope.enableNarrowNetwork) {
              if (rateRow[7] == 0) {
                tot = rateRow[3] + rateRow[9] + rateRow[10] - rateRow[11] - rateRow[5] - rateRow[5];
              } else {
                tot = rateRow[7] + rateRow[9] + rateRow[10] - rateRow[11];
              }

            }

            else {
              if (rateRow[7] == 0) {
                tot = rateRow[3] + rateRow[9] + rateRow[10] - rateRow[11] - rateRow[5] - rateRow[5];
              }
              else {
                tot = rateRow[7] + rateRow[9] + rateRow[10] - rateRow[11];
              }
            }


            chartData.labels.push([rateRow[1].replace('(Advocate Health System Network Choice)', "***").trim(),
            "(Net Cost: $" + tot.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,') + ")"]);

            chartData.datasets[0].data.push((rateRow[3]));//Premium+Spousal
            chartData.datasets[1].data.push(rateRow[9]);//Deductible
            chartData.datasets[2].data.push(rateRow[10]);//Copay 
            if (!$scope.config.isHawaiiZip()) {
              chartData.datasets[3].data.push(rateRow[5]);//Tobacoo
              if ($scope.enableNarrowNetwork)
              chartData.datasets[4].data.push(rateRow[11]);//HSA - NarrowNetwork
              else
              chartData.datasets[4].data.push(rateRow[11]);//HSA - NOT NarrowNetwork 
            } else {
              if ($scope.enableNarrowNetwork)
              chartData.datasets[3].data.push(rateRow[11]);//HSA - NarrowNetwork
              else
              chartData.datasets[3].data.push(rateRow[11]);//HSA - NOT NarrowNetwork 
            }
             
            

          }
        }
      }
      else {
        console.log("IN HERE");
        console.log(chartData);
        $("#chartWrapper").hide();
        $("#chartWrappermsg").show();
        $("#chartWrappermsg").html('</div><h4>No applicable options.</h4></div>');

      }
    })      
  }
  $scope.renderChart = function(){
      console.log(chartData);
    var heightOfGraph = 200 + 40 * (chartData.labels.length);
        var heightOfGraphContainer;
        if(chartData.labels.length<=2){
          heightOfGraphContainer = 2*heightOfGraph;
          heightOfGraph = 1.9*heightOfGraph;
        }else{
          heightOfGraphContainer = heightOfGraph+10;
        }
        $("#chartWrapper").html('<div style="width:90%;margin:0 auto;height:' + heightOfGraphContainer + 'px;overflow-y:auto;"><div style="width:100%;margin:0 auto;height:' + heightOfGraph + 'px;"><canvas id="chart"></canvas></div></div>');
    var ctx = document.getElementById('chart');
    var myChart = new Chart(ctx, {
      type: 'horizontalBar',
      data: chartData,
      options: {
        responsive:true,
        maintainAspectRatio: false,
        scales: {
          xAxes: [{
            stacked: true,
            gridLines: { display: true },
            ticks: {
              callback: function(label, index, labels) {
                if(isNaN(label)){
                return "";
                }else {
                  return "$ "+Number(label).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }
               
              }
            }
          }],
          yAxes: [{
            barThickness:15,
            categoryPercentage:0.7,
            barPercentage: 0.2,
            gridLines: { display: false }
          }]
          },
		tooltips: {
            position: "nearest",
			mode: 'label',
			callbacks: {
			  afterTitle: function() {
				  window.chartHoverTotal = 0;
			  },
			  label: function(tooltipItem, data) {
                          var dataPoint = data.datasets[tooltipItem.datasetIndex].label;
                          var dataNote="";
                          var valor = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                          if(tooltipItem.datasetIndex==3){
                            //dataNote = " can reduce your deductible or you can save";
                            window.chartHoverTotal -= Number.parseFloat(valor);
                          } else if(tooltipItem.datasetIndex==4){
                            window.chartHoverTotal -= Number.parseFloat(valor);
                            //dataNote = " reduces your premium";
                          } else if(tooltipItem.datasetIndex==5){
                            window.chartHoverTotal -= Number.parseFloat(valor);
                            dataNote = " can reduce your deductible or you can save";
                          }
                          else
                            window.chartHoverTotal += Number.parseFloat(valor);
                          return dataPoint + dataNote + ": $" + valor.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
                      },
			  footer: function() {
				  return "TOTAL: $" + window.chartHoverTotal.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
			  }
			}
		}
      }
    });
  }
  $scope.initalizeChartData();
  $scope.prepChartData();
  $scope.renderChart();
